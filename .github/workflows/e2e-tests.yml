name: E2E Tests with Cypress

on:
  push:
    branches: [ "feature/**", "develop/**", "release/**" ]
    paths:
      - 'frontend/**'   
      - 'backend/**'
      - 'docker-compose.test.yml'
      - '.github/workflows/e2e-tests.yml'
  pull_request:
    branches: [ main, develop, feature/**, release/** ]
    types: [ opened, synchronize, reopened ]
  workflow_dispatch:  # Manual trigger for testing

env:
  DOCKER_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}

jobs:
  cypress-e2e:
    runs-on: ubuntu-latest
    name: Run Cypress E2E Tests
    
    steps:
      # 1. Checkout code
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. Set up Node.js for Cypress
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: 'frontend/package-lock.json'

      # 3. Install Cypress dependencies
      - name: Install Cypress dependencies
        working-directory: ./frontend
        run: |
          npm ci
          npm install -D cypress-mochawesome-reporter mochawesome mochawesome-merge mochawesome-report-generator

      # 4. Log in to Docker Hub to pull images
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # 5. Pull latest Docker images
      - name: Pull Docker Images
        run: |
          echo "Pulling latest images from Docker Hub..."
          docker pull ${{ env.DOCKER_USERNAME }}/apartment-backend:latest
          docker pull ${{ env.DOCKER_USERNAME }}/apartment-frontend:latest
          docker pull mysql:8.0
          echo "âœ… All images pulled successfully"

      # 6. Create test environment file
      - name: Create .env file for testing
        run: |
          cat > .env << EOF
          DOCKER_USERNAME=${{ env.DOCKER_USERNAME }}
          MYSQL_ROOT_PASSWORD=root123
          MYSQL_DATABASE=apartment_db
          SPRING_DATASOURCE_URL=jdbc:mysql://mysql:3306/apartment_db
          SPRING_DATASOURCE_USERNAME=root
          SPRING_DATASOURCE_PASSWORD=root123
          VITE_API_URL=http://localhost:8080
          EOF

      # 7. Start Application Stack with Docker Compose
      - name: Start Application Stack
        run: |
          echo "Starting services with Docker Compose..."
          docker compose -f docker-compose.test.yml up -d
          
          echo "Waiting for MySQL to be ready..."
          timeout 120s bash -c 'until docker compose -f docker-compose.test.yml exec -T mysql mysqladmin ping -h localhost --silent; do echo "Waiting for MySQL..."; sleep 5; done'
          echo "âœ… MySQL is ready"
          
          echo "Waiting for Backend to be ready..."
          timeout 120s bash -c 'until curl -f http://localhost:8080/actuator/health 2>/dev/null; do echo "Waiting for Backend..."; sleep 5; done'
          echo "âœ… Backend is ready"
          
          echo "Waiting for Frontend to be ready..."
          timeout 60s bash -c 'until curl -f http://localhost:5173 2>/dev/null; do echo "Waiting for Frontend..."; sleep 3; done'
          echo "âœ… Frontend is ready"
          
          # Additional wait for app stabilization
          echo "Waiting 10 seconds for app to stabilize..."
          sleep 10
          
          echo "ğŸ‰ All services are up and running!"

      # 8. Display running containers for debugging
      - name: Show running containers
        if: always()
        run: docker compose -f docker-compose.test.yml ps

      # 9. Run Cypress E2E tests
      - name: Run Cypress Tests
        working-directory: ./frontend
        env:
          CYPRESS_baseUrl: http://localhost:5173
        run: |
          echo "ğŸ§ª Running Cypress E2E tests..."
          npx cypress run --browser chrome --config video=true

      # 10. Upload test videos
      - name: Upload Cypress Videos
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cypress-videos
          path: frontend/cypress/videos/
          retention-days: 30

      # 12. Upload test screenshots (failures only)
      - name: Upload Cypress Screenshots
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: cypress-screenshots
          path: frontend/cypress/screenshots/
          retention-days: 30
          if-no-files-found: ignore

      # 13. Display test summary
      - name: E2E Test Summary
        if: always()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ§ª Cypress E2E Test Execution Complete"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ğŸ“¦ Artifacts uploaded:"
          echo "  - Videos (all tests)"
          echo "  - Screenshots (failures only)"
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      # 14. Show container logs on failure
      - name: Show Backend Logs
        if: failure()
        run: docker compose -f docker-compose.test.yml logs backend

      - name: Show Frontend Logs
        if: failure()
        run: docker compose -f docker-compose.test.yml logs frontend

      # 18. Cleanup - Teardown environment
      - name: Teardown Environment
        if: always()
        run: |
          echo "ğŸ§¹ Cleaning up test environment..."
          docker compose -f docker-compose.test.yml down -v
          echo "âœ… Cleanup complete"
