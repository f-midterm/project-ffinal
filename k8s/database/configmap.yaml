# ============================================
# DATABASE INITIALIZATION CONFIGMAP
# ============================================
# Contains the init.sql script to initialize the database schema
# This script creates all tables, indexes, and sample data
apiVersion: v1
kind: ConfigMap
metadata:
  name: mysql-init-cm
  namespace: superproject-ns
  labels:
    app: apartment-system
    component: database
data:
  init.sql: |
    -- ============================================
    -- Apartment Management System Database Schema
    -- PRODUCTION-READY VERSION
    -- ============================================

    USE apartment_db;

    -- Drop tables in reverse dependency order
    DROP TABLE IF EXISTS rental_requests;
    DROP TABLE IF EXISTS maintenance_requests;
    DROP TABLE IF EXISTS payments;
    DROP TABLE IF EXISTS leases;
    DROP TABLE IF EXISTS tenants;
    DROP TABLE IF EXISTS units;
    DROP TABLE IF EXISTS users;

    -- ============================================
    -- USERS TABLE
    -- ============================================
    CREATE TABLE users (
        id BIGINT AUTO_INCREMENT PRIMARY KEY,
        username VARCHAR(50) UNIQUE NOT NULL,
        password VARCHAR(255) NOT NULL,
        email VARCHAR(254) UNIQUE NOT NULL,
        role ENUM('ADMIN', 'USER', 'VILLAGER') NOT NULL DEFAULT 'USER',
        created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
        updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
        deleted_at DATETIME NULL,
        INDEX idx_email (email),
        INDEX idx_username (username)
    ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

    -- ============================================
    -- UNITS TABLE
    -- ============================================
    CREATE TABLE units (
        id BIGINT AUTO_INCREMENT PRIMARY KEY,
        room_number VARCHAR(10) UNIQUE NOT NULL,
        floor INT NOT NULL,
        status ENUM('AVAILABLE', 'OCCUPIED', 'MAINTENANCE', 'RESERVED') NOT NULL DEFAULT 'AVAILABLE',
        type VARCHAR(50) NOT NULL,
        rent_amount DECIMAL(10,2) NOT NULL,
        size_sqm DECIMAL(8,2),
        description TEXT,
        created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
        updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
        deleted_at DATETIME NULL,
        INDEX idx_floor (floor),
        INDEX idx_status (status),
        INDEX idx_room_number (room_number),
        CONSTRAINT chk_rent_amount CHECK (rent_amount > 0),
        CONSTRAINT chk_floor CHECK (floor > 0)
    ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

    -- ============================================
    -- TENANTS TABLE
    -- ============================================
    CREATE TABLE tenants (
        id BIGINT AUTO_INCREMENT PRIMARY KEY,
        first_name VARCHAR(50) NOT NULL,
        last_name VARCHAR(50) NOT NULL,
        phone VARCHAR(20) NOT NULL,
        email VARCHAR(254) NOT NULL,
        occupation VARCHAR(100),
        emergency_contact VARCHAR(255) NOT NULL,
        emergency_phone VARCHAR(20) NOT NULL,
        status ENUM('ACTIVE', 'INACTIVE', 'PENDING') NOT NULL DEFAULT 'ACTIVE',
        created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
        updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
        deleted_at DATETIME NULL,
        INDEX idx_name (first_name, last_name),
        INDEX idx_phone (phone),
        INDEX idx_email (email),
        INDEX idx_status (status),
        UNIQUE KEY idx_email_unique (email)
    ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

    -- ============================================
    -- LEASES TABLE
    -- ============================================
    CREATE TABLE leases (
        id BIGINT AUTO_INCREMENT PRIMARY KEY,
        tenant_id BIGINT NOT NULL,
        unit_id BIGINT NOT NULL,
        start_date DATE NOT NULL,
        end_date DATE NOT NULL,
        monthly_rent DECIMAL(10,2) NOT NULL,
        billing_cycle ENUM('MONTHLY', 'QUARTERLY', 'YEARLY') NOT NULL DEFAULT 'MONTHLY',
        deposit_amount DECIMAL(10,2) NOT NULL,
        status ENUM('ACTIVE', 'EXPIRED', 'TERMINATED', 'PENDING') NOT NULL DEFAULT 'PENDING',
        created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
        updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
        deleted_at DATETIME NULL,
        FOREIGN KEY (tenant_id) REFERENCES tenants(id) ON DELETE RESTRICT,
        FOREIGN KEY (unit_id) REFERENCES units(id) ON DELETE RESTRICT,
        INDEX idx_tenant_id (tenant_id),
        INDEX idx_unit_id (unit_id),
        INDEX idx_status (status),
        INDEX idx_dates (start_date, end_date),
        CONSTRAINT chk_dates CHECK (end_date > start_date),
        CONSTRAINT chk_monthly_rent CHECK (monthly_rent > 0),
        CONSTRAINT chk_deposit CHECK (deposit_amount >= 0)
    ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

    -- ============================================
    -- PAYMENTS TABLE
    -- ============================================
    CREATE TABLE payments (
        id BIGINT AUTO_INCREMENT PRIMARY KEY,
        lease_id BIGINT NOT NULL,
        payment_type ENUM('RENT', 'ELECTRICITY', 'WATER', 'MAINTENANCE', 'SECURITY_DEPOSIT', 'OTHER') NOT NULL DEFAULT 'RENT',
        amount DECIMAL(10,2) NOT NULL,
        due_date DATE NOT NULL,
        paid_date DATE,
        payment_method ENUM('CASH', 'BANK_TRANSFER', 'CHECK', 'ONLINE') DEFAULT 'CASH',
        status ENUM('PENDING', 'PAID', 'OVERDUE', 'PARTIAL') NOT NULL DEFAULT 'PENDING',
        receipt_number VARCHAR(50) UNIQUE,
        notes TEXT,
        created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
        updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
        deleted_at DATETIME NULL,
        FOREIGN KEY (lease_id) REFERENCES leases(id) ON DELETE RESTRICT,
        INDEX idx_lease_id (lease_id),
        INDEX idx_due_date (due_date),
        INDEX idx_status (status),
        INDEX idx_payment_type (payment_type),
        CONSTRAINT chk_amount CHECK (amount > 0)
    ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

    -- ============================================
    -- MAINTENANCE_REQUESTS TABLE
    -- ============================================
    CREATE TABLE maintenance_requests (
        id BIGINT AUTO_INCREMENT PRIMARY KEY,
        unit_id BIGINT NOT NULL,
        tenant_id BIGINT,
        description TEXT NOT NULL,
        priority ENUM('LOW', 'MEDIUM', 'HIGH', 'URGENT') NOT NULL DEFAULT 'MEDIUM',
        status ENUM('OPEN', 'IN_PROGRESS', 'COMPLETED', 'CANCELLED') NOT NULL DEFAULT 'OPEN',
        reported_date DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
        completed_date DATETIME,
        created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
        updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
        deleted_at DATETIME NULL,
        FOREIGN KEY (unit_id) REFERENCES units(id) ON DELETE RESTRICT,
        FOREIGN KEY (tenant_id) REFERENCES tenants(id) ON DELETE SET NULL,
        INDEX idx_unit_id (unit_id),
        INDEX idx_tenant_id (tenant_id),
        INDEX idx_status (status),
        INDEX idx_priority (priority),
        INDEX idx_reported_date (reported_date)
    ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

    -- ============================================
    -- RENTAL_REQUESTS TABLE
    -- ============================================
    CREATE TABLE rental_requests (
        id BIGINT AUTO_INCREMENT PRIMARY KEY,
        first_name VARCHAR(50) NOT NULL,
        last_name VARCHAR(50) NOT NULL,
        email VARCHAR(254) NOT NULL,
        phone VARCHAR(20) NOT NULL,
        unit_id BIGINT,
        preferred_move_in_date DATE,
        occupation VARCHAR(100),
        monthly_income DECIMAL(10,2),
        message TEXT,
        status ENUM('PENDING', 'APPROVED', 'REJECTED', 'CANCELLED') NOT NULL DEFAULT 'PENDING',
        created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
        updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
        deleted_at DATETIME NULL,
        FOREIGN KEY (unit_id) REFERENCES units(id) ON DELETE SET NULL,
        INDEX idx_unit_id (unit_id),
        INDEX idx_status (status),
        INDEX idx_email (email),
        INDEX idx_created_at (created_at)
    ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

    -- ============================================
    -- SAMPLE DATA
    -- ============================================

    -- Insert Admin User (password: admin123)
    INSERT INTO users (username, email, password, role) VALUES
    ('admin', 'admin@apartment.com', '$2a$10$xqXLNHXqBhW3bJZ1wHvMEOp5iJNJZ5kkH5/lZXOp7wXwNrXqXLNHX', 'ADMIN'),
    ('user1', 'user1@apartment.com', '$2a$10$xqXLNHXqBhW3bJZ1wHvMEOp5iJNJZ5kkH5/lZXOp7wXwNrXqXLNHX', 'USER'),
    ('villager1', 'villager1@apartment.com', '$2a$10$xqXLNHXqBhW3bJZ1wHvMEOp5iJNJZ5kkH5/lZXOp7wXwNrXqXLNHX', 'VILLAGER');

    -- Insert Units (24 units: 12 per floor, 2 floors)
    INSERT INTO units (room_number, floor, type, rent_amount, size_sqm, status, description) VALUES
    -- Floor 1
    ('101', 1, 'Studio', 8000.00, 30.00, 'AVAILABLE', 'Cozy studio apartment on ground floor'),
    ('102', 1, 'Studio', 8000.00, 30.00, 'AVAILABLE', 'Cozy studio apartment on ground floor'),
    ('103', 1, '1BR', 12000.00, 45.00, 'OCCUPIED', 'One bedroom with kitchen and living area'),
    ('104', 1, '1BR', 12000.00, 45.00, 'AVAILABLE', 'One bedroom with kitchen and living area'),
    ('105', 1, '2BR', 18000.00, 65.00, 'AVAILABLE', 'Two bedrooms, spacious living area'),
    ('106', 1, '2BR', 18000.00, 65.00, 'MAINTENANCE', 'Two bedrooms, spacious living area'),
    ('107', 1, 'Studio', 8500.00, 32.00, 'AVAILABLE', 'Modern studio with balcony'),
    ('108', 1, 'Studio', 8500.00, 32.00, 'OCCUPIED', 'Modern studio with balcony'),
    ('109', 1, '1BR', 13000.00, 50.00, 'AVAILABLE', 'Large one bedroom unit'),
    ('110', 1, '1BR', 13000.00, 50.00, 'AVAILABLE', 'Large one bedroom unit'),
    ('111', 1, '2BR', 19000.00, 70.00, 'RESERVED', 'Premium two bedroom with city view'),
    ('112', 1, '2BR', 19000.00, 70.00, 'AVAILABLE', 'Premium two bedroom with city view'),
    -- Floor 2
    ('201', 2, 'Studio', 9000.00, 30.00, 'AVAILABLE', 'Upper floor studio with better view'),
    ('202', 2, 'Studio', 9000.00, 30.00, 'OCCUPIED', 'Upper floor studio with better view'),
    ('203', 2, '1BR', 13500.00, 45.00, 'AVAILABLE', 'Upper floor one bedroom'),
    ('204', 2, '1BR', 13500.00, 45.00, 'AVAILABLE', 'Upper floor one bedroom'),
    ('205', 2, '2BR', 19500.00, 65.00, 'OCCUPIED', 'Upper floor two bedroom'),
    ('206', 2, '2BR', 19500.00, 65.00, 'AVAILABLE', 'Upper floor two bedroom'),
    ('207', 2, 'Studio', 9500.00, 32.00, 'AVAILABLE', 'Premium studio with large balcony'),
    ('208', 2, 'Studio', 9500.00, 32.00, 'AVAILABLE', 'Premium studio with large balcony'),
    ('209', 2, '1BR', 14000.00, 50.00, 'OCCUPIED', 'Deluxe one bedroom unit'),
    ('210', 2, '1BR', 14000.00, 50.00, 'AVAILABLE', 'Deluxe one bedroom unit'),
    ('211', 2, '2BR', 20000.00, 70.00, 'AVAILABLE', 'Penthouse-style two bedroom'),
    ('212', 2, '2BR', 20000.00, 70.00, 'MAINTENANCE', 'Penthouse-style two bedroom');

    -- Insert Tenants
    INSERT INTO tenants (first_name, last_name, phone, email, occupation, emergency_contact, emergency_phone, status) VALUES
    ('John', 'Smith', '555-0101', 'john.smith@email.com', 'Software Engineer', 'Jane Smith', '555-0102', 'ACTIVE'),
    ('Sarah', 'Johnson', '555-0201', 'sarah.j@email.com', 'Teacher', 'Mike Johnson', '555-0202', 'ACTIVE'),
    ('Michael', 'Brown', '555-0301', 'mbrown@email.com', 'Marketing Manager', 'Lisa Brown', '555-0302', 'ACTIVE'),
    ('Emily', 'Davis', '555-0401', 'emily.davis@email.com', 'Nurse', 'Robert Davis', '555-0402', 'ACTIVE'),
    ('David', 'Wilson', '555-0501', 'dwilson@email.com', 'Accountant', 'Mary Wilson', '555-0502', 'INACTIVE');

    -- Insert Active Leases
    INSERT INTO leases (tenant_id, unit_id, start_date, end_date, monthly_rent, billing_cycle, deposit_amount, status) VALUES
    (1, 3, '2024-01-01', '2024-12-31', 12000.00, 'MONTHLY', 24000.00, 'ACTIVE'),
    (2, 8, '2024-02-01', '2025-01-31', 8500.00, 'MONTHLY', 17000.00, 'ACTIVE'),
    (3, 2, '2024-03-01', '2025-02-28', 9000.00, 'MONTHLY', 18000.00, 'ACTIVE'),
    (4, 5, '2024-04-01', '2025-03-31', 19500.00, 'MONTHLY', 39000.00, 'ACTIVE'),
    (5, 9, '2023-06-01', '2024-05-31', 14000.00, 'MONTHLY', 28000.00, 'EXPIRED');

    -- Insert Payments
    INSERT INTO payments (lease_id, payment_type, amount, due_date, paid_date, payment_method, status, notes) VALUES
    (1, 'RENT', 12000.00, '2024-01-01', '2024-01-01', 'BANK_TRANSFER', 'PAID', 'January 2024 rent'),
    (1, 'RENT', 12000.00, '2024-02-01', '2024-02-01', 'BANK_TRANSFER', 'PAID', 'February 2024 rent'),
    (2, 'RENT', 8500.00, '2024-02-01', '2024-02-01', 'BANK_TRANSFER', 'PAID', 'February 2024 rent'),
    (2, 'RENT', 8500.00, '2024-03-01', '2024-03-01', 'BANK_TRANSFER', 'PAID', 'March 2024 rent'),
    (3, 'RENT', 9000.00, '2024-03-01', '2024-03-01', 'CASH', 'PAID', 'March 2024 rent'),
    (4, 'RENT', 19500.00, '2024-04-01', '2024-04-01', 'BANK_TRANSFER', 'PAID', 'April 2024 rent');

    -- Insert Maintenance Requests
    INSERT INTO maintenance_requests (unit_id, tenant_id, description, priority, status, reported_date) VALUES
    (3, 1, 'Air conditioning not cooling properly', 'HIGH', 'IN_PROGRESS', NOW()),
    (6, NULL, 'Plumbing leak in bathroom', 'URGENT', 'OPEN', NOW()),
    (8, 2, 'Light fixture needs replacement', 'LOW', 'COMPLETED', DATE_SUB(NOW(), INTERVAL 7 DAY)),
    (12, NULL, 'Door lock needs repair', 'MEDIUM', 'OPEN', NOW());

    -- Insert Rental Requests
    INSERT INTO rental_requests (first_name, last_name, email, phone, unit_id, preferred_move_in_date, occupation, monthly_income, message, status) VALUES
    ('Alice', 'Anderson', 'alice.a@email.com', '555-1001', 1, '2024-12-01', 'Graphic Designer', 45000.00, 'Looking for a quiet studio apartment', 'PENDING'),
    ('Bob', 'Baker', 'bob.baker@email.com', '555-1002', 4, '2024-11-15', 'Sales Executive', 60000.00, 'Need 1BR for family', 'APPROVED'),
    ('Carol', 'Clark', 'carol.c@email.com', '555-1003', 7, '2025-01-01', 'Student', 25000.00, 'Student looking for affordable housing', 'PENDING');
